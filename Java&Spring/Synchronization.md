# 동기화란?
> 멀티쓰레드 프로세스의 경우 여러 쓰레드가 자원을 공유해서 작업하기 때문에 서로에게 영향을 줄 수 있다.

- 위와 같은 상황을 방지하기 위해 한 **쓰레드가 진행중인 작업을 다른 쓰레드가 간섭하지 못하도록 막는 것**

## 공유자원 / 임계영역
### 공유자원
- 여러 쓰레드가 동시에 접근할 수 있는 자원
### 임계 영역
- 공유자원들 중 여러 쓰레드가 동시에 접근했을 때 **문제가 생길 수 있는 부분**

		![[Pasted image 20230927002643.png]]

## 경쟁 상태
- 둘 이상의 쓰레드가 공유자원을 병행적으로 읽거나 쓰는 동작을 할 때 타이밍이나 접근 순서에 따라 실행 결과가 달라지는 상황
- 이러한 경쟁 상태를 방지하기 위해선 **원자성, 가시성**을 보장해야한다.
### 원자성
- 공유 자원에 대한 작업의 단위가 더이상 쪼개질 수 없는 하나의 연산인 것처럼 동작하는 것 
### 가시성
- 한 쓰레드에서 변경한 특정 메모리 값이, 다른 쓰레드에서 제대로 읽어지는가 
#### CPU Cache
- 쓰레드는 CPU가 실행한다. 
  이때, 기본적으론 RAM에서 변수 값을 읽어와서 실행하게 된다.
- 하지만 메인 메모리와 CPU간의 거리가 멀어 CPU Cache를 사용한다.
##### 동작 방식
- CPU는 쓰레드를 실행할 때 필요한 값을 메모리에서 읽어오고 CPU cache에 담아두고 모든 연산을 반영한 후 RAM에 적재한다.
##### 가시성 문제
- RAM에서 변경된 값과, CPU cache의 값이 일치하지 않아 실제 값을 보지 못하게 된다.
##### volatile
- 변수 앞에 volatile 이라는 키워드를 붙여서 선언하게 되면 이 변수는 메인 메모리에서만 값을 읽고 쓰며, CPU cache를 사용하지 않는 변수가 된다.

## 동기화
### Blocking
- 특정 쓰레드가 작업을 수행하는 동안 다른 작업은 진행하지 않고 대기하는 방식
#### 모니터
- 자바에서 동기화를 하기 위한 도구
##### Synchronized
- 배타 동기를 선언하는 키워드
- 연산 결과가 메모리에 써질때까지 다른 쓰레드는 임계영역에 들어올 수 없게 한다.
- 순차접근을 통해 원자성,가시성을 동시에 챙길 수 있다.

- 단점
	- 성능저하
	- 데드락 발생
###### 데드락
- 서로가 점유하는 자원을 놓지않고 서로의 자원을 기다리는 현상
### Non-Blocking
- 다른 쓰레드의 작업여부와 상관없이 자신의 작업을 수행하는 방식
#### Atomic 타입
- 동시성을 보장하기 위해서 자바에서 제공하는 Wrapper class
- 일반적인 쓰레드에서는 값을 연산하고자 할때 캐시에서 변수를 가져온다.
	- Atomic을 사용하게 되면 내부에 volatile이 있어서 JVM 메모리에서 바로 쓰레드로 값을 가져올 수 있다.
- 연산시에는 compareAndSet() 메서드가 호출된다.
	- CAS 알고리즘
	- 원자성 보장
## ThreadLocal
- 해당 쓰레드만 접근할 수 있는 특별한 저장소
